[env]
TURBO_TELEMETRY_DISABLED = "1"
DO_NOT_TRACK = "1"
DOTNET_CLI_TELEMETRY_OPTOUT = "1"

[tools]
node = "latest"
graphite = "latest"
github-cli = "latest"
bun = "1.3.9"
dotnet = "10.0"

[hooks]
preinstall = '''
  command -v node &> /dev/null || echo "Node.js is not installed. Please install Node.js to continue."
'''
postinstall = '''
  (cd frontend && bun pm pkg set packageManager=bun@$(bun --version) && test -d node_modules || bun install) || true
  if [ ! -f .mise-setup-done ]; then
    (cd backend && dotnet restore; dotnet tool restore) || true
    (cd frontend && bunx playwright install --with-deps chromium) || true
    echo 'mise setup complete' > .mise-setup-done
  fi
'''

[settings]
experimental = true

[settings.npm]
package_manager = "bun"


[tasks."backend:start"]
description = "Start the backend"
depends = ["db:wait"]
dir = "backend"
run = "bun run start"

[tasks."db:up"]
description = "Start the database container"
run = "docker compose -f docker/docker-compose.infra.yml up -d db"

[tasks."db:down"]
description = "Stop the database container"
run = "docker compose -f docker/docker-compose.infra.yml down"

[tasks."db:wait"]
description = "Wait for the database to be ready"
depends = ["db:up"]
run = """
  echo 'Waiting for database...'
  until [ "$(docker inspect --format='{% raw %}{{.State.Health.Status}}{% endraw %}' researchcruiseapp-db 2>/dev/null)" = "healthy" ]; do
    sleep 1
  done
  echo 'Database is ready'
"""

[tasks."db:del"]
description = "Delete the database volume and admin log"
depends = ["db:down"]
run = """
  docker volume rm researchcruiseapp_researchcruiseapp-db 2>/dev/null || true
  rm -f admin.log
"""

[tasks."admin:password"]
description = "Reset database and capture admin password"
depends = ["db:del"]
alias = "admin"
run = '''
  mise run db:wait
  fifo=$(mktemp -u)
  mkfifo "$fifo"
  cleanup() {
    status=${1:-$?}
    trap - EXIT INT TERM HUP QUIT
    if [ -n "${pid:-}" ] && kill -0 "$pid" 2>/dev/null; then
      kill -TERM -- "-$pid" 2>/dev/null || kill "$pid" 2>/dev/null || true
      wait "$pid" 2>/dev/null || true
    fi
    rm -f "$fifo"
    exit "$status"
  }
  trap 'cleanup' EXIT
  trap 'cleanup 130' INT
  trap 'cleanup 143' TERM
  trap 'cleanup 129' HUP
  trap 'cleanup 131' QUIT
  if command -v setsid >/dev/null 2>&1; then
    setsid mise run backend:start > "$fifo" 2>&1 &
  else
    mise run backend:start > "$fifo" 2>&1 &
  fi
  pid=$!
  while IFS= read -r line; do
    echo "$line"
    if echo "$line" | grep -qi admin; then
      email=$(echo "$line" | grep -oP '[\w.+-]+@[\w.-]+')
      pass=$(echo "$line" | grep -oP '(?<=- ).*')
      printf 'Email:\n%s\nPassword:\n%s' "$email" "$pass" > admin.log
      echo 'Admin password info saved to admin.log'
      kill -TERM -- "-$pid" 2>/dev/null || kill "$pid" 2>/dev/null || true
      wait "$pid" 2>/dev/null || true
      break
    fi
  done < "$fifo"
'''
